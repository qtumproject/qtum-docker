FROM qtumtoolchain-alpine-build

ENV PREFIX=/opt/cross
ENV TARGET=i686-elf
ENV SYSROOT=/opt/x86-compiler/sysroot
ENV PATH=${PATH}:${SYSROOT}/bin:$PREFIX/bin:/root/qtum:/root/qtum:/root/qtum-docker/proto-x86/utils

RUN set -ex \
    && cd qx86-codeify \
    && make -j4 

# build the freestanding compiler
RUN set -ex \
    && cd x86-toolchain \
    && mkdir build-binutils \
    && cd build-binutils \
    && ../binutils-2.29/configure --target="$TARGET" --prefix="$PREFIX" --disable-werror \
    && make \
    && make install \
    && cd .. \
    && mkdir build-gcc \
    && cd gcc-7.2.0 \
    && ./contrib/download_prerequisites \
    && cd ../build-gcc \
    && ../gcc-7.2.0/configure --target="$TARGET" --prefix="$PREFIX" --enable-languages=c,c++ \
    && make all-gcc -j4 \
    && make all-target-libgcc \
    && make install-gcc \
    && make install-target-libgcc

ENV TARGET=i686-qtum

#compile QtumOS compiler and supports
RUN set -ex \
    && ls $PREFIX/bin \
    && i686-elf-gcc -v \
    && cd FsLibc \
    && cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=cross-toolchain.cmake -DCMAKE_INSTALL_PREFIX=$SYSROOT/usr . \
    && make -C libc \
    && make -C libc install \
    && cd /x86-toolchain/crtfiles \
    && make \
    && cd .. \
    && mkdir -p $SYSROOT/usr/lib \
    && mkdir -p $SYSROOT/usr/include \
    && cp crtfiles/*.o $SYSROOT/usr/lib/ \
    && cp -r includes/* $SYSROOT/usr/include/ \
    && rm -rf build-binutils \
    && mkdir build-binutils \
    && cd build-binutils \
    && ../binutils-2.29/configure --target=$TARGET --prefix="$PREFIX" --with-sysroot="$SYSROOT" --disable-werror \
    && make \
    && make install \
    && cd .. \
    && rm -rf build-gcc \
    && mkdir build-gcc \
    && cd build-gcc \
    && ../gcc-7.2.0/configure --target=$TARGET --prefix="$PREFIX" --with-sysroot="$SYSROOT" --enable-languages=c \
    && make all-gcc -j4 \
    && make all-target-libgcc \
    && make install-gcc \
    && make install-target-libgcc

# build libqtum
RUN set -ex \
    && cd libqtum \
    && make -j2 \
    && make deploy \
    && make deploy

FROM alpine:3.9.4

RUN apk --no-cache add make \
                            musl \
                            db-dev

COPY --from=0 /lib /lib
COPY --from=0 /qx86-codeify/qx86-codeify /usr/local/bin
COPY --from=0 /opt/cross /opt/cross
COPY --from=0 /opt/x86-compiler/sysroot /opt/x86-compiler/sysroot
COPY --from=0 /usr/include /usr/include

ENV PATH=${PATH}:/opt/x86-compiler/sysroot/bin:/opt/cross/bin:/root/qtum:/usr/local/bin
ENV CC=i686-qtum-gcc
ENV LD=i686-qtum-ld
ENV CXX=i686-qtum-g++
ENV CPP=i686-qtum-cpp
ENV AR=i686-qtum-ar
ENV STRIP=i686-qtum-strip
ENV OBJCOPY=i686-qtum-objcopy